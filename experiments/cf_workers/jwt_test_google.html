<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <meta name="google-signin-client_id"
        content="595564072050-5t4i14ge3g0b7knrhn8an9pujha53m6q.apps.googleusercontent.com">
  <meta charset="UTF-8">
  <title>Title</title>
</head>
<body>


<div class="g-signin2" data-onsuccess="onSignIn"></div>


<script async defer>
  let googleKeys = {};
  const keyType = {
    name: 'RSASSA-PKCS1-v1_5',
    hash: 'sha-256'
  };
  (async function () {
    const response = await fetch('https://www.googleapis.com/oauth2/v3/certs');
    const rawKeys = await response.json();
    for (let googKey of rawKeys.keys)
      googleKeys[googKey.kid] = await crypto.subtle.importKey('jwk', googKey, keyType, false, ['verify']);
    console.log(googleKeys);
  })();


  function Uint8ToBase64url(one) {
    const two = String.fromCharCode.apply(null, new Uint16Array(one));
    const three = btoa(two);
    return three.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+/g, '');
  }

  function base64urlToUint8Array(four) {
    let three = four.replace(/-/g, '+').replace(/_/g, '/');
    const pad = three.length % 4;
    if (pad === 2)
      three += '==';
    else if (pad === 3)
      three += '=';
    const two = atob(three);
    const one = new Uint8Array(two.length);
    for (let i = 0; i < two.length; i++)
      one[i] = two.charCodeAt(i);
    return one;
  }

  function toBase64url(obj) {
    return btoa(JSON.stringify(obj)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
  }

  function base64urlToString(base64url) {
    let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
    const pad = base64.length % 4;
    if (pad === 2)
      base64 += '==';
    else if (pad === 3)
      base64 += '=';
    return atob(base64);
  }

  async function signJwt(rawJWTobj, privKey) {
    const base64urlHeader = toBase64url(rawJWTobj.header);
    const base64urlPayload = toBase64url(rawJWTobj.payload);
    const data = base64urlHeader + '.' + base64urlPayload;

    const signature = await crypto.subtle.sign({
      name: 'RSASSA-PKCS1-v1_5',
      hash: 'sha-256'
    }, privKey, new TextEncoder().encode(data));
    return data + '.' + Uint8ToBase64url(new Uint8Array(signature));
  }

  async function verifyAndExtract(jwt, pubKeys) {
    const [h64, p64, s64] = jwt.split('.');
    const header = JSON.parse(base64urlToString(h64));

    const pubKey = pubKeys[header.kid];
    const signature = base64urlToUint8Array(s64);
    const data = new TextEncoder().encode(h64 + "." + p64);
    const algorithm = {name: 'RSASSA-PKCS1-v1_5', hash: 'sha-256'};
    const verify = await crypto.subtle.verify(algorithm, pubKey, signature, data);
    if (!verify)
      throw 'hackkkkk!';
    return {header, payload: JSON.parse(base64urlToString(p64))};
  }

  async function onSignIn(googleUser) {
    var profile = googleUser.getBasicProfile();
    console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
    console.log('Name: ' + profile.getName());
    console.log('Image URL: ' + profile.getImageUrl());
    console.log('Email: ' + profile.getEmail()); // This is null if the 'email' scope is not present.
    const jwt = googleUser.getAuthResponse().id_token;
    console.log(jwt);
    console.log(await verifyAndExtract(jwt, googleKeys));
  }
</script>

<!--<a href="#" onclick="signOut();">Sign out</a>-->
<!--<script>-->
<!--  function signOut() {-->
<!--    var auth2 = gapi.auth2.getAuthInstance();-->
<!--    auth2.signOut().then(function () {-->
<!--      console.log('User signed out.');-->
<!--    });-->
<!--  }-->
<!--</script>-->
</body>
</html>